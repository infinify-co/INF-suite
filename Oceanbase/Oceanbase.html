<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Database Builder - INF Dashboard</title>
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
    <link rel="stylesheet" href="styles.css?v=1">
    <link href="https://fonts.googleapis.com/css2?family=Open+Sans:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/lucide@latest/dist/umd/lucide.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        /* Back Tile Styles */
        .back-tile {
            position: absolute;
            top: 0;
            left: 260px;
            bottom: 0;
            width: 230px;
            background: #ffffff;
            z-index: 998;
            border-radius: 20px 0 0 20px;
            overflow: visible;
        }

        /* Secondary Sidebar Styles */
        .secondary-sidebar {
            height: 100%;
            display: flex;
            flex-direction: column;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #ffffff;
            transform: translateX(-250px);
        }

        .secondary-sidebar-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 20px 24px;
            border-bottom: 1px solid #e5e7eb;
        }

        .secondary-sidebar-brand {
            font-weight: 700;
            font-size: 16px;
            color: #000000;
            letter-spacing: -0.02em;
        }

        .secondary-sidebar-icon {
            width: 20px;
            height: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .secondary-sidebar-icon svg {
            color: #6b7280;
        }

        .secondary-sidebar-nav {
            flex: 1;
            padding: 16px 0;
            overflow-y: auto;
        }

        .secondary-nav-back {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 10px 24px;
            color: #000000;
            font-size: 14px;
            cursor: pointer;
            transition: background-color 0.2s, color 0.2s;
            position: relative;
            border-radius: 8px;
            margin: 0 8px;
        }

        .secondary-nav-back:hover {
            color: #000000;
            background-color: #f9fafb;
        }

        .secondary-nav-list {
            margin-top: 8px;
        }

        .secondary-nav-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 10px 24px;
            color: #000000;
            font-size: 14px;
            cursor: pointer;
            transition: background-color 0.2s, border-radius 0.2s;
            position: relative;
            border-radius: 8px;
            margin: 0 8px;
        }

        .secondary-nav-item:hover {
            background-color: #f9fafb;
            border-radius: 8px;
        }

        .secondary-nav-item.active {
            background-color: #f3f4f6;
            border-radius: 8px;
        }

        /* Adjust front tile to account for back tile */
        .front-tile {
            left: 270px;
        }

        .front-tile-container {
            transform: scale(0.85);
            width: 117.65%;
            height: 117.65%;
            transform-origin: top left;
            overflow-y: auto;
            scrollbar-width: none;
            -ms-overflow-style: none;
        }

        .front-tile-container::-webkit-scrollbar {
            display: none;
        }


        /* Change database highlight from blue to white */
        .database-highlight {
            background: #ffffff !important;
            border: 1px solid #e5e7eb !important;
        }

        .database-highlight::after {
            display: none !important;
        }

        .database-highlight .btn-secondary {
            border-color: #d1d5db !important;
        }

        .database-highlight .btn-secondary:hover {
            border-color: #9ca3af !important;
            color: #1f2937 !important;
        }

        .database-highlight .btn-primary {
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1) !important;
        }

        /* Change database tiles from blue to white */
        .database-tile {
            background: #ffffff !important;
            border: 1px solid #e5e7eb !important;
        }

        .database-tile::after {
            display: none !important;
        }

        .database-tile-icon {
            background: #f3f4f6 !important;
            color: #1f2937 !important;
        }

        .database-tile-icon.alt {
            background: #f3f4f6 !important;
            color: #1f2937 !important;
        }

        .database-tile-icon.highlight {
            background: #f3f4f6 !important;
            color: #1f2937 !important;
        }
    </style>
</head>
<body class="dashboard-page database-page">
    <!-- Navigation -->
    <nav class="navbar">
        <div class="nav-container">
            <div class="nav-logo">
                <a href="dashboard.html">
                    <img src="INF.logo2.png" alt="INF Logo" class="inf-logo-img">
                </a>
                <div class="nav-logo-line"></div>
            </div>
            <ul class="nav-menu">
                <li><a href="dashboard.html" class="nav-link active">Suite</a></li>
            </ul>
            <div class="nav-actions">
                <button class="icon-btn" title="Chat">
                    <i data-lucide="message-circle"></i>
                </button>
                <button class="icon-btn" title="Settings">
                    <i data-lucide="settings"></i>
                </button>
            </div>
            <div class="hamburger">
                <span class="bar"></span>
                <span class="bar"></span>
                <span class="bar"></span>
            </div>
        </div>
    </nav>

    <!-- Vertical Dock -->
    <div class="vertical-dock">
        <div class="dock-logo">
            <img src="INF.logo3.png" alt="INF Logo" class="dock-logo-img">
        </div>
        <div class="dock-items">
            <div class="dock-item" onclick="window.location.href='home.html'">
                <i data-lucide="home"></i>
                <span class="dock-label">Home</span>
            </div>
            <div class="dock-item" onclick="window.location.href='Operation.html'">
                <i data-lucide="hard-hat"></i>
                <span class="dock-label">Operation</span>
            </div>
            <div class="dock-item" onclick="window.location.href='work.html'">
                <img src="work.2.png" alt="Teams" style="width: 32px; height: 32px; object-fit: contain; border-radius: 6px;">
                <span class="dock-label">Users</span>
            </div>
            <div class="dock-item" onclick="window.location.href='Agents.html'">
                <i data-lucide="cpu"></i>
                <span class="dock-label">Agents</span>
            </div>
            <div class="dock-item" onclick="window.location.href='Kreative.html'">
                <img src="Kreative.png" alt="Kreative" style="width: 32px; height: 32px; object-fit: contain; border-radius: 6px;">
                <span class="dock-label">Account</span>
            </div>
            <div class="dock-item" onclick="window.location.href='Devra.html'">
                <i data-lucide="squares-exclude"></i>
                <span class="dock-label">Devra</span>
            </div>
            <div class="dock-item" onclick="window.location.href='campaigns.html'">
                <i data-lucide="focus"></i>
                <span class="dock-label">Campaigns</span>
            </div>
            <div class="dock-item active" onclick="window.location.href='Oceanbase.html'">
                <img src="oceanbase.1.jpg" alt="Database" style="width: 32px; height: 32px; object-fit: contain; border-radius: 6px;">
                <span class="dock-label">Data</span>
            </div>
            <div class="dock-item" onclick="window.location.href='Online-assets.html'">
                <i data-lucide="container"></i>
                <span class="dock-label">Online assets</span>
            </div>
            <div class="dock-item" onclick="window.location.href='filebase/homebase.html'">
                <i data-lucide="folder-tree"></i>
                <span class="dock-label">Filebase</span>
            </div>
            <div class="dock-item" onclick="window.location.href='financial.html'">
                <i data-lucide="landmark"></i>
                <span class="dock-label">Financials</span>
            </div>
            <div class="dock-item" onclick="window.location.href='chats.html'">
                <i data-lucide="message-circle-more"></i>
                <span class="dock-label">Chats</span>
            </div>
        </div>
    </div>

    <!-- Main Content -->
    <main class="dashboard-main database-main">
        <!-- Back Tile (Secondary Sidebar) -->
        <div class="back-tile">
            <div class="secondary-sidebar">
                <div class="secondary-sidebar-header">
                    <div class="secondary-sidebar-brand">Database</div>
                    <div class="secondary-sidebar-icon">
                        <svg width="12" height="12" viewBox="0 0 12 12" fill="none" xmlns="http://www.w3.org/2000/svg">
                            <path d="M6 1V11M1 6H11" stroke="currentColor" stroke-width="1.5" stroke-linecap="round"/>
                        </svg>
                    </div>
                </div>
                <div class="secondary-sidebar-nav">
                    <div class="secondary-nav-list">
                        <div class="secondary-nav-back active" onclick="window.location.href='Oceanbase/overview.html'">
                            <span>Overview</span>
                        </div>
                        <div class="secondary-nav-item" data-nav="client-table" onclick="window.location.href='Oceanbase/client-table.html'">
                            <span>Client table</span>
                        </div>
                        <div class="secondary-nav-item" data-nav="queries">
                            <span>Queries</span>
                        </div>
                        <div class="secondary-nav-item" data-nav="reports">
                            <span>Reports</span>
                        </div>
                        <div class="secondary-nav-item" data-nav="connections" onclick="window.location.href='Oceanbase/connections.html'">
                            <span>Connections</span>
                        </div>
                        <div class="secondary-nav-item" data-nav="settings">
                            <span>Settings</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Front Tile -->
        <div class="front-tile">
            <div class="front-tile-container">
                <div class="database-container">
                    <!-- Main Content Area -->
                    <div class="database-content" style="width: 100%;">
                        <!-- Highlight Tile -->
                        <section class="database-highlight">
                            <div class="database-highlight-left">
                                <h2>Database Builder</h2>
                                <p>Spin up collaborative tables, design forms, and automate workflows across your teams in minutes.</p>
                            </div>
                            <div class="database-highlight-actions">
                                <button class="btn-primary" onclick="databaseBuilder.openWizard()">Create Database</button>
                                <button class="btn-secondary" onclick="databaseManager.showImport()">Import Data</button>
                            </div>
                        </section>

                        <section class="database-quick-tiles">
                            <div class="database-tile">
                                <div class="database-tile-icon">
                                    <i data-lucide="sparkles"></i>
                                </div>
                                <div class="database-tile-body">
                                    <h3>AI Templates</h3>
                                    <p>Jump-start with curated table layouts for CRM, finance, and operations.</p>
                                </div>
                                <button class="btn-secondary btn-pill" onclick="databaseBuilder.openWizard()">Browse Templates</button>
                            </div>

                            <div class="database-tile">
                                <div class="database-tile-icon alt">
                                    <i data-lucide="layers"></i>
                                </div>
                                <div class="database-tile-body">
                                    <h3>Sync Sources</h3>
                                    <p>Connect spreadsheets, APIs, or Supabase tables for live data sync.</p>
                                </div>
                                <button class="btn-secondary btn-pill" onclick="databaseManager.showImport()">Set up Sync</button>
                            </div>

                            <div class="database-tile">
                                <div class="database-tile-icon highlight">
                                    <img src="work.2.png" alt="Teams" style="width: 32px; height: 32px; object-fit: contain; border-radius: 6px;">
                                </div>
                                <div class="database-tile-body">
                                    <h3>Collaborate</h3>
                                    <p>Invite teams, manage permissions, and automate reviews with guardrails.</p>
                                </div>
                                <button class="btn-secondary btn-pill" onclick="databaseManager.showSharing()">Share Access</button>
                            </div>
                        </section>

                        <!-- View Toggle -->
                        <div class="view-toggle" id="view-toggle">
                            <button class="toggle-btn active" data-view="table" onclick="databaseManager.setView('table')">
                                üìä Table View
                            </button>
                            <button class="toggle-btn" data-view="form" onclick="databaseManager.setView('form')">
                                üìù Form View
                            </button>
                            <div class="view-actions">
                                <button class="btn-secondary btn-small" onclick="databaseManager.showFilters()" id="filter-btn">
                                    üîç Filter
                                </button>
                                <button class="btn-secondary btn-small" onclick="databaseManager.showImport()" id="import-btn">
                                    üì• Import
                                </button>
                                <button class="btn-secondary btn-small" onclick="databaseManager.showReports()" id="report-btn">
                                    üìä Reports
                                </button>
                                <button class="btn-secondary btn-small" onclick="databaseManager.showSharing()" id="share-btn">
                                    üîó Share
                                </button>
                            </div>
                        </div>

                        <!-- Empty State -->
                        <div class="database-empty-state" id="database-empty-state">
                            <div class="empty-state-content">
                                <h2>Welcome to Database Builder</h2>
                                <p>Create simple databases for your data. Perfect for contacts, inventory, recipes, and more.</p>
                                <button class="btn-primary btn-large" onclick="databaseBuilder.openWizard()">
                                    ‚ûï Create Your First Database
                                </button>
                            </div>
                        </div>

                        <!-- Table View -->
                        <div class="table-view-container" id="table-view" style="display: none;">
                            <!-- Populated by table-view.js -->
                        </div>

                        <!-- Form View -->
                        <div class="form-view-container" id="form-view" style="display: none;">
                            <!-- Populated by form-view.js -->
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <!-- Circle in bottom right corner -->
        <div style="position: fixed; bottom: 20px; right: 20px; width: 45px; height: 45px; border-radius: 50%; box-shadow: 0 4px 12px rgba(96, 165, 250, 0.3); z-index: 1000; overflow: hidden;">
            <img src="sorif.1.jpg" alt="Sorif" style="width: 100%; height: 100%; object-fit: cover;">
        </div>
    </main>

    <!-- Database Builder Wizard Modal -->
    <div class="wizard-modal" id="database-wizard" style="display: none;">
        <div class="wizard-modal-content">
            <div class="wizard-close" onclick="databaseBuilder.closeWizard()">√ó</div>
            <div id="wizard-container">
                <!-- Populated by database-builder.js -->
            </div>
        </div>
    </div>

    <!-- Scripts -->
    <!-- AWS Cognito -->
    <script src="https://unpkg.com/amazon-cognito-identity-js@6.3.0/dist/amazon-cognito-identity.min.js"></script>
    <script src="cognito-config.js"></script>
    <script src="cognito-auth.js"></script>
    <script src="navigation-handler.js"></script>
    <script src="templates.js"></script>
    <script src="client-database-service.js"></script>
    <script src="backup-service.js"></script>
    <script src="database-builder.js"></script>
    <script src="table-view.js"></script>
    <script src="form-view.js"></script>
    <script src="import-service.js"></script>
    <script src="view-builder.js"></script>
    <script src="report-generator.js"></script>
    <script src="sharing-service.js"></script>
    <script src="storage-service.js"></script>
    <script src="realtime-service.js"></script>
    
    <script>
        // Database Manager - Coordinates all components
        class DatabaseManager {
            constructor() {
                this.currentView = 'table';
                this.currentTableName = null;
                this.currentTableSchema = null;
            }

            async init() {
                // Initialize wizard
                if (window.databaseBuilder) {
                    window.databaseBuilder.init('wizard-container');
                }

                // Show empty state initially
                this.showEmptyState();
            }

            setView(view) {
                this.currentView = view;
                
                // Update toggle buttons
                document.querySelectorAll('.toggle-btn').forEach(btn => {
                    btn.classList.remove('active');
                    if (btn.dataset.view === view) {
                        btn.classList.add('active');
                    }
                });

                // Show/hide views
                const tableView = document.getElementById('table-view');
                const formView = document.getElementById('form-view');
                const emptyState = document.getElementById('database-empty-state');

                if (this.currentTableName && this.currentTableSchema) {
                    tableView.style.display = view === 'table' ? 'block' : 'none';
                    formView.style.display = view === 'form' ? 'block' : 'none';
                    emptyState.style.display = 'none';

                    // Initialize the selected view
                    if (view === 'table' && window.tableView) {
                        window.tableView.init(this.currentTableName, this.currentTableSchema, 'table-view');
                    } else if (view === 'form' && window.formView) {
                        window.formView.init(this.currentTableName, this.currentTableSchema, 'form-view');
                    }
                } else {
                    this.showEmptyState();
                }
            }

            async loadDatabase(database) {
                if (!database) {
                    this.showEmptyState();
                    return;
                }

                // Show empty state until a table is selected
                this.showEmptyState();
            }

            async loadTable(tableName, tableSchema) {
                if (!tableName || !tableSchema) {
                    this.showEmptyState();
                    return;
                }

                this.currentTableName = tableName;
                this.currentTableSchema = tableSchema;

                // Hide empty state
                document.getElementById('database-empty-state').style.display = 'none';

                // Show view toggle
                document.getElementById('view-toggle').style.display = 'flex';

                // Load the current view
                this.setView(this.currentView);
            }

            showFilters() {
                if (this.currentTableSchema && window.viewBuilder) {
                    window.viewBuilder.showFilterBuilder(this.currentTableSchema, (filters) => {
                        if (window.tableView) {
                            window.tableView.setFilters(filters);
                        }
                    });
                }
            }

            showImport() {
                if (!this.currentTableName || !this.currentTableSchema) {
                    alert('Please select a table first');
                    return;
                }

                const input = document.createElement('input');
                input.type = 'file';
                input.accept = '.csv,.xlsx,.xls';
                input.onchange = (e) => {
                    const file = e.target.files[0];
                    if (file && window.importService) {
                        window.importService.handleFileSelect(
                            file,
                            this.currentTableSchema,
                            null,
                            () => {
                                // Reload table data after import
                                if (window.tableView) {
                                    window.tableView.loadData().then(() => {
                                        window.tableView.render();
                                    });
                                }
                            }
                        );
                    }
                };
                input.click();
            }

            showReports() {
                if (!this.currentTableName || !this.currentTableSchema) {
                    alert('Please select a table first');
                    return;
                }

                if (window.tableView && window.reportGenerator) {
                    const data = window.tableView.data || [];
                    window.reportGenerator.showReportModal(data, this.currentTableSchema);
                }
            }

            showSharing() {
                if (!this.currentDatabase) {
                    alert('Please select a database first');
                    return;
                }

                if (window.sharingService) {
                    window.sharingService.showSharingModal(
                        this.currentDatabase.id,
                        this.currentDatabase.name
                    );
                }
            }

            async loadDatabase(database) {
                this.currentDatabase = database;
                if (!database) {
                    this.showEmptyState();
                    return;
                }
                // Show empty state until a table is selected
                this.showEmptyState();
            }

            showEmptyState() {
                document.getElementById('database-empty-state').style.display = 'flex';
                document.getElementById('table-view').style.display = 'none';
                document.getElementById('form-view').style.display = 'none';
                document.getElementById('view-toggle').style.display = 'none';
                this.currentTableName = null;
                this.currentTableSchema = null;
            }

            clearContent() {
                this.showEmptyState();
            }
        }

        // Initialize on page load
        document.addEventListener('DOMContentLoaded', async () => {
            // Initialize Lucide icons
            if (window.lucide) lucide.createIcons();

            // Initialize navigation
            if (typeof initNavigation === 'function') {
                initNavigation();
            }

            // Initialize dock labels
            const dockItems = Array.from(document.querySelectorAll('.dock-item'));
            dockItems.forEach(item => {
                const label = item.querySelector('.dock-label');
                if (label) {
                    item.addEventListener('mouseenter', () => {
                        const rect = item.getBoundingClientRect();
                        label.style.top = `${rect.top + rect.height / 2 - 100}px`;
                    });
                }
            });

            // Initialize database manager
            const databaseManager = new DatabaseManager();
            window.databaseManager = databaseManager;
            await databaseManager.init();

            // Initialize share access if accessed via share link
            if (window.sharingService) {
                await window.sharingService.initShareAccess();
            }
        });
    </script>
</body>
</html>

