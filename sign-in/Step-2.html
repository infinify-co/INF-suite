<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Complete Your Profile - Infinify</title>
    <link rel="stylesheet" href="../styles.css">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Open+Sans:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <!-- Users Service for AWS integration -->
    <script src="../users-service.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Open Sans', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #ffffff;
            display: flex;
            align-items: center;
            justify-content: center;
            min-height: 100vh;
            padding: 20px;
        }

        .signin-container {
            width: 100%;
            max-width: 400px;
        }

        .signin-card {
            background: #ffffff;
            border-radius: 12px;
            padding: 40px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
            border: 1px solid rgba(0, 0, 0, 0.05);
        }

        .signin-title {
            font-family: 'Open Sans', sans-serif;
            font-size: 28px;
            font-weight: 700;
            color: #1f2937;
            margin-bottom: 8px;
            text-align: center;
        }

        .signin-description {
            font-family: 'Open Sans', sans-serif;
            font-size: 15px;
            color: #6b7280;
            margin-bottom: 32px;
            line-height: 1.5;
            text-align: center;
        }

        .form-group {
            margin-bottom: 20px;
            margin-top: 0;
            position: relative;
        }

        .form-label-container {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-top: 20px;
            margin-left: 5px;
            margin-bottom: 8px;
        }

        .form-label {
            display: block;
            font-size: 14px;
            font-weight: 500;
            color: #374151;
            margin-bottom: 0;
            margin-left: 0;
            margin-top: 0;
        }

        .form-label .optional {
            font-weight: 400;
            color: #9ca3af;
        }

        .form-input {
            width: 100%;
            padding: 12px 16px;
            background: #ffffff;
            border: 1px solid #e5e7eb;
            border-radius: 12px;
            font-size: 15px;
            color: #1f2937;
            outline: none;
            transition: border-color 0.2s, background-color 0.2s;
            box-sizing: border-box;
        }

        .form-input:focus {
            border-color: #3b82f6;
            background: #ffffff;
        }

        .form-input::placeholder {
            color: #9ca3af;
        }

        .form-input.error {
            border-color: #ef4444;
        }

        .error-message {
            display: flex;
            align-items: center;
            gap: 6px;
            font-size: 14px;
            color: #ef4444;
            visibility: hidden;
            opacity: 0;
            transition: opacity 0.2s;
        }

        .error-message.show {
            visibility: visible;
            opacity: 1;
        }

        .error-icon {
            width: 16px;
            height: 16px;
            min-width: 16px;
            border-radius: 50%;
            background: #ef4444;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
        }

        .error-icon::before {
            content: '!';
            color: #ffffff;
            font-size: 12px;
            font-weight: 700;
            line-height: 1;
        }

        .continue-button {
            width: 100%;
            padding: 14px 16px;
            background: #000000;
            border: none;
            border-radius: 8px;
            font-size: 15px;
            font-weight: 600;
            color: #ffffff;
            cursor: pointer;
            margin-top: 8px;
            margin-bottom: 10px;
            transition: background-color 0.2s;
        }

        .continue-button:hover {
            background: #1f2937;
        }

        .continue-button:disabled {
            background: #9ca3af;
            cursor: not-allowed;
        }

        .progress-indicator {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 8px;
            margin-bottom: 32px;
        }

        .progress-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: #e5e7eb;
            transition: background-color 0.2s;
        }

        .progress-dot.active {
            background: #3b82f6;
        }

        .progress-dot.completed {
            background: #10b981;
        }

        /* Modern Dropdown Styles */
        .modern-dropdown {
            position: relative;
            margin-bottom: 20px;
            margin-top: 0;
        }
        
        .modern-dropdown .form-label {
            display: block;
            font-size: 14px;
            font-weight: 500;
            color: #374151;
            margin-bottom: 8px;
            margin-left: 0;
            margin-top: 0;
        }

        .modern-dropdown .form-label-container {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-top: 20px;
            margin-left: 5px;
            margin-bottom: 8px;
        }

        .dropdown-button {
            width: 100%;
            padding: 12px 16px;
            background: #ffffff;
            border: 1px solid #e5e7eb;
            border-radius: 8px;
            font-family: 'Open Sans', sans-serif;
            font-size: 15px;
            font-weight: 500;
            color: #374151;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: space-between;
            transition: all 0.2s;
            text-align: left;
            box-sizing: border-box;
        }

        .dropdown-button:hover {
            background: #f9fafb;
            border-color: #d1d5db;
        }

        .dropdown-button.active {
            border-color: #3b82f6;
            background: #ffffff;
        }

        .dropdown-button-text {
            flex: 1;
            color: #374151;
        }

        .dropdown-button-placeholder {
            color: #9ca3af;
        }

        .dropdown-arrow {
            width: 16px;
            height: 16px;
            color: #9ca3af;
            transition: transform 0.2s;
            flex-shrink: 0;
            margin-left: 12px;
        }

        .dropdown-button.active .dropdown-arrow {
            transform: rotate(180deg);
            color: #3b82f6;
        }

        .dropdown-menu {
            position: absolute;
            top: calc(100% + 4px);
            left: 0;
            right: 0;
            background: #ffffff;
            border: 1px solid #e5e7eb;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
            z-index: 1000;
            max-height: 300px;
            overflow: hidden;
            display: none;
            flex-direction: column;
        }

        .dropdown-menu.show {
            display: flex;
        }

        .dropdown-search {
            padding: 12px 16px;
            border: none;
            border-bottom: 1px solid #e5e7eb;
            border-radius: 8px 8px 0 0;
            font-family: 'Open Sans', sans-serif;
            font-size: 14px;
            color: #374151;
            outline: none;
            background: #ffffff;
        }

        .dropdown-search::placeholder {
            color: #9ca3af;
        }

        .dropdown-list {
            max-height: 240px;
            overflow-y: auto;
            padding: 4px;
        }

        .dropdown-item {
            padding: 10px 16px;
            font-family: 'Open Sans', sans-serif;
            font-size: 14px;
            color: #374151;
            cursor: pointer;
            border-radius: 6px;
            transition: background-color 0.15s;
            display: block;
        }

        .dropdown-item:hover {
            background: #f3f4f6;
        }

        .dropdown-item.selected {
            background: #eff6ff;
            color: #3b82f6;
            font-weight: 600;
        }

        .dropdown-empty {
            padding: 16px;
            text-align: center;
            color: #9ca3af;
            font-size: 14px;
            font-family: 'Open Sans', sans-serif;
        }

        .username-prefix {
            color: #6b7280;
            font-weight: 500;
        }
    </style>
</head>
<body>
    <div class="signin-container">
        <div class="signin-card">
            <div class="progress-indicator">
                <div class="progress-dot completed"></div>
                <div class="progress-dot active"></div>
            </div>
            
            <h1 class="signin-title">Complete Your Profile</h1>
            <p class="signin-description">Tell us a bit more about yourself to personalize your experience.</p>
            
            <!-- Profile Form -->
            <form id="profileForm" novalidate>
                <div class="form-group">
                    <div class="form-label-container">
                        <label for="businessName" class="form-label">Business name</label>
                        <div class="error-message" id="businessName-error">
                            <div class="error-icon"></div>
                            <span>Business name is required.</span>
                        </div>
                    </div>
                    <input 
                        type="text" 
                        id="businessName" 
                        name="businessName" 
                        class="form-input" 
                        placeholder="Enter your business name"
                        autocomplete="organization"
                    >
                </div>

                <div class="form-group" style="margin-bottom: 30px;">
                    <div class="form-label-container">
                        <label for="businessUsername" class="form-label">Business username</label>
                        <div class="error-message" id="businessUsername-error">
                            <div class="error-icon"></div>
                            <span>Username is required.</span>
                        </div>
                    </div>
                    <div style="position: relative;">
                        <span class="username-prefix" style="position: absolute; left: 16px; top: 50%; transform: translateY(-50%); pointer-events: none;">@</span>
                        <input 
                            type="text" 
                            id="businessUsername" 
                            name="businessUsername" 
                            class="form-input" 
                            placeholder="username"
                            autocomplete="username"
                            style="padding-left: 30px;"
                        >
                    </div>
                </div>

                <div class="modern-dropdown">
                    <div class="form-label-container">
                        <label for="businessOperations" class="form-label">Business operations</label>
                    </div>
                    <button type="button" class="dropdown-button" id="businessOperationsButton">
                        <span class="dropdown-button-text" id="businessOperationsButtonText">
                            <span class="dropdown-button-placeholder">Select country</span>
                        </span>
                        <svg class="dropdown-arrow" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" />
                        </svg>
                    </button>
                    <div class="dropdown-menu" id="businessOperationsMenu">
                        <input type="text" class="dropdown-search" id="businessOperationsSearch" placeholder="Search countries...">
                        <div class="dropdown-list" id="businessOperationsList"></div>
                    </div>
                </div>

                <div class="form-group">
                    <div class="form-label-container">
                        <label for="jobTitle" class="form-label">Your job title</label>
                    </div>
                    <input 
                        type="text" 
                        id="jobTitle" 
                        name="jobTitle" 
                        class="form-input" 
                        placeholder="Your job title or role"
                        autocomplete="organization-title"
                    >
                </div>
                
                <button type="submit" class="continue-button" id="submitButton">Continue</button>
            </form>
        </div>
    </div>

    <script>
        // Custom validation
        function validateField(input, errorElement, errorMessage) {
            const value = input.value.trim();
            const errorText = errorElement.querySelector('span');
            
            if (!value) {
                input.classList.add('error');
                if (errorText) {
                    errorText.textContent = errorMessage;
                }
                errorElement.classList.add('show');
                return false;
            } else {
                input.classList.remove('error');
                errorElement.classList.remove('show');
                return true;
            }
        }

        function validateUsername(username) {
            if (!username || username.trim() === '') {
                return false;
            }
            // Username validation: only letters, numbers, and dots allowed
            // No spaces, no special characters except dots
            const usernameRegex = /^[a-zA-Z0-9.]+$/;
            return usernameRegex.test(username) && username.length >= 3;
        }

        // Country list with Global as first option
        const countries = [
            'Global',
            'United States', 'Canada', 'Mexico', 'United Kingdom', 'Germany', 'France', 'Italy', 'Spain',
            'Australia', 'New Zealand', 'Japan', 'China', 'India', 'South Korea', 'Singapore', 'Brazil',
            'Argentina', 'Chile', 'South Africa', 'Egypt', 'Nigeria', 'Kenya', 'Saudi Arabia', 'United Arab Emirates',
            'Israel', 'Turkey', 'Russia', 'Poland', 'Netherlands', 'Belgium', 'Sweden', 'Norway', 'Denmark',
            'Finland', 'Switzerland', 'Austria', 'Ireland', 'Portugal', 'Greece', 'Czech Republic', 'Hungary',
            'Romania', 'Bulgaria', 'Croatia', 'Thailand', 'Malaysia', 'Indonesia', 'Philippines', 'Vietnam',
            'Taiwan', 'Hong Kong', 'Pakistan', 'Bangladesh', 'Sri Lanka', 'Nepal', 'Myanmar', 'Cambodia',
            'Laos', 'Mongolia', 'Kazakhstan', 'Uzbekistan', 'Ukraine', 'Belarus', 'Lithuania', 'Latvia',
            'Estonia', 'Slovakia', 'Slovenia', 'Serbia', 'Bosnia and Herzegovina', 'Albania', 'Macedonia',
            'Montenegro', 'Kosovo', 'Moldova', 'Georgia', 'Armenia', 'Azerbaijan', 'Iraq', 'Iran', 'Jordan',
            'Lebanon', 'Syria', 'Yemen', 'Oman', 'Qatar', 'Kuwait', 'Bahrain', 'Afghanistan',
            'Colombia', 'Peru', 'Venezuela', 'Ecuador', 'Bolivia', 'Paraguay', 'Uruguay', 'Guyana',
            'Suriname', 'French Guiana', 'Panama', 'Costa Rica', 'Guatemala', 'Honduras', 'El Salvador',
            'Nicaragua', 'Belize', 'Jamaica', 'Trinidad and Tobago', 'Barbados', 'Bahamas', 'Dominican Republic',
            'Haiti', 'Cuba', 'Puerto Rico', 'Morocco', 'Algeria', 'Tunisia', 'Libya', 'Sudan', 'Ethiopia',
            'Tanzania', 'Uganda', 'Ghana', 'Ivory Coast', 'Senegal', 'Cameroon', 'Angola', 'Mozambique',
            'Madagascar', 'Zimbabwe', 'Zambia', 'Malawi', 'Rwanda', 'Burundi', 'Somalia', 'Djibouti',
            'Eritrea', 'Mauritania', 'Mali', 'Burkina Faso', 'Niger', 'Chad', 'Central African Republic',
            'Democratic Republic of the Congo', 'Republic of the Congo', 'Gabon', 'Equatorial Guinea',
            'Guinea', 'Guinea-Bissau', 'Sierra Leone', 'Liberia', 'Togo', 'Benin', 'Gambia', 'Cape Verde',
            'Mauritius', 'Seychelles', 'Comoros', 'Botswana', 'Namibia', 'Lesotho', 'Eswatini', 'Malawi'
        ];

        // Get form elements
        const form = document.getElementById('profileForm');
        const businessNameInput = document.getElementById('businessName');
        const businessUsernameInput = document.getElementById('businessUsername');
        const businessNameError = document.getElementById('businessName-error');
        const businessUsernameError = document.getElementById('businessUsername-error');
        const submitButton = document.getElementById('submitButton');

        // Real-time validation
        businessNameInput.addEventListener('blur', function() {
            validateField(this, businessNameError, 'Business name is required.');
        });

        businessUsernameInput.addEventListener('blur', function() {
            const value = this.value.trim();
            if (!value) {
                validateField(this, businessUsernameError, 'Username is required.');
            } else if (!validateUsername(value)) {
                this.classList.add('error');
                const errorText = businessUsernameError.querySelector('span');
                if (errorText) {
                    errorText.textContent = 'Username can only contain letters, numbers, and dots.';
                }
                businessUsernameError.classList.add('show');
            } else {
                this.classList.remove('error');
                businessUsernameError.classList.remove('show');
            }
        });

        // Clear errors on input
        businessNameInput.addEventListener('input', function() {
            if (this.classList.contains('error') && this.value.trim()) {
                this.classList.remove('error');
                businessNameError.classList.remove('show');
            }
        });

        businessUsernameInput.addEventListener('input', function() {
            if (this.classList.contains('error') && this.value.trim()) {
                const value = this.value.trim();
                if (validateUsername(value) || value === '') {
                    this.classList.remove('error');
                    businessUsernameError.classList.remove('show');
                }
            }
            // Prevent spaces and special characters except dots
            this.value = this.value.replace(/[^a-zA-Z0-9.]/g, '');
        });

        // Dropdown Functionality for Business Operations
        function initCountryDropdown() {
            const button = document.getElementById('businessOperationsButton');
            const menu = document.getElementById('businessOperationsMenu');
            const search = document.getElementById('businessOperationsSearch');
            const list = document.getElementById('businessOperationsList');
            const buttonText = document.getElementById('businessOperationsButtonText');
            let selectedValue = '';

            // Populate dropdown list
            function populateList(items) {
                list.innerHTML = '';
                if (items.length === 0) {
                    list.innerHTML = '<div class="dropdown-empty">No results found</div>';
                    return;
                }
                items.forEach(item => {
                    const itemEl = document.createElement('div');
                    itemEl.className = 'dropdown-item';
                    if (item === selectedValue) {
                        itemEl.classList.add('selected');
                    }
                    itemEl.textContent = item;
                    itemEl.addEventListener('click', function() {
                        selectedValue = item;
                        buttonText.innerHTML = item;
                        button.classList.remove('active');
                        menu.classList.remove('show');
                        search.value = '';
                        populateList(countries);
                    });
                    list.appendChild(itemEl);
                });
            }

            // Initial population
            populateList(countries);

            // Toggle dropdown
            button.addEventListener('click', function(e) {
                e.stopPropagation();
                const isActive = button.classList.contains('active');
                
                // Close all other dropdowns
                document.querySelectorAll('.dropdown-menu').forEach(m => {
                    if (m !== menu) m.classList.remove('show');
                });
                document.querySelectorAll('.dropdown-button').forEach(b => {
                    if (b !== button) b.classList.remove('active');
                });

                if (isActive) {
                    button.classList.remove('active');
                    menu.classList.remove('show');
                } else {
                    button.classList.add('active');
                    menu.classList.add('show');
                    search.focus();
                }
            });

            // Search functionality
            search.addEventListener('input', function() {
                const query = this.value.toLowerCase().trim();
                const filtered = countries.filter(item => 
                    item.toLowerCase().includes(query)
                );
                populateList(filtered);
            });

            // Close dropdown when clicking outside
            document.addEventListener('click', function(e) {
                if (!button.contains(e.target) && !menu.contains(e.target)) {
                    button.classList.remove('active');
                    menu.classList.remove('show');
                    search.value = '';
                    populateList(countries);
                }
            });
        }

        // Initialize country dropdown
        initCountryDropdown();

        // Handle form submission
        form.addEventListener('submit', async function(e) {
            e.preventDefault();
            
            let isValid = true;
            
            // Validate business name (required)
            if (!validateField(businessNameInput, businessNameError, 'Business name is required.')) {
                isValid = false;
            }
            
            // Validate business username (required)
            const usernameValue = businessUsernameInput.value.trim();
            if (!usernameValue) {
                validateField(businessUsernameInput, businessUsernameError, 'Username is required.');
                isValid = false;
            } else if (!validateUsername(usernameValue)) {
                businessUsernameInput.classList.add('error');
                const errorText = businessUsernameError.querySelector('span');
                if (errorText) {
                    errorText.textContent = 'Username can only contain letters, numbers, and dots.';
                }
                businessUsernameError.classList.add('show');
                isValid = false;
            }
            
            // Validate business operations (country) - required
            const selectedCountry = document.getElementById('businessOperationsButtonText').textContent.trim();
            if (selectedCountry === 'Select country' || !selectedCountry) {
                isValid = false;
                // You can add error display for dropdown if needed
            }
            
            if (isValid) {
                // Show loading state
                const originalButtonText = submitButton.textContent;
                submitButton.disabled = true;
                submitButton.textContent = 'Saving...';
                
                // Collect form data
                const formData = {
                    businessName: businessNameInput.value.trim(),
                    businessUsername: '@' + usernameValue,
                    businessOperations: selectedCountry,
                    jobTitle: document.getElementById('jobTitle').value.trim() || null
                };
                
                // Get Cognito user ID from signup data
                const signupData = JSON.parse(localStorage.getItem('signupData') || '{}');
                const cognitoUserId = signupData.cognitoUserId || signupData.email;
                
                // Save to AWS via API
                try {
                    // Check if usersService is available
                    if (window.usersService) {
                        // Update user in Aurora database
                        await window.usersService.updateUser(cognitoUserId, formData);
                    } else {
                        // Fallback: Store in localStorage if API not available
                        const userData = JSON.parse(localStorage.getItem('signupData') || '{}');
                        Object.assign(userData, formData);
                        localStorage.setItem('signupData', JSON.stringify(userData));
                        console.warn('UsersService not available, data saved to localStorage');
                    }
                    
                    // Redirect to home page
                    window.location.href = '../suite/home.html';
                    
                } catch (error) {
                    console.error('Error saving profile:', error);
                    
                    // Show error message
                    const errorMessage = 'Unable to save profile. Please try again.';
                    const businessNameErrorText = businessNameError.querySelector('span');
                    businessNameInput.classList.add('error');
                    if (businessNameErrorText) {
                        businessNameErrorText.textContent = errorMessage;
                    }
                    businessNameError.classList.add('show');
                    
                    // Reset button
                    submitButton.disabled = false;
                    submitButton.textContent = originalButtonText;
                }
            }
        });
    </script>
</body>
</html>

