<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Database Builder - INF Dashboard</title>
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
    <link rel="stylesheet" href="styles.css?v=1">
    <link href="https://fonts.googleapis.com/css2?family=Open+Sans:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/lucide@latest/dist/umd/lucide.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body class="dashboard-page database-page">
    <!-- Navigation -->
    <nav class="navbar">
        <div class="nav-container">
            <div class="nav-logo">
                <a href="dashboard.html">
                    <img src="INF.logo2.png" alt="INF Logo" class="inf-logo-img">
                </a>
                <div class="nav-logo-line"></div>
            </div>
            <ul class="nav-menu">
                <li><a href="dashboard.html" class="nav-link active">Suite</a></li>
            </ul>
            <div class="nav-actions">
                <button class="icon-btn" title="Chat">
                    <i data-lucide="message-circle"></i>
                </button>
                <button class="icon-btn" title="Settings">
                    <i data-lucide="settings"></i>
                </button>
            </div>
            <div class="hamburger">
                <span class="bar"></span>
                <span class="bar"></span>
                <span class="bar"></span>
            </div>
        </div>
    </nav>

    <!-- Vertical Dock -->
    <div class="vertical-dock">
        <div class="dock-logo">
            <img src="INF.logo3.png" alt="INF Logo" class="dock-logo-img">
        </div>
        <div class="dock-items">
            <div class="dock-item" onclick="window.location.href='home.html'">
                <i data-lucide="home"></i>
                <span class="dock-label">Home</span>
            </div>
            <div class="dock-item" onclick="window.location.href='operations.html'">
                <i data-lucide="monitor-cog"></i>
                <span class="dock-label">Operations</span>
            </div>
            <div class="dock-item" onclick="window.location.href='teams.html'">
                <i data-lucide="users"></i>
                <span class="dock-label">Users</span>
            </div>
            <div class="dock-item" onclick="window.location.href='chats.html'">
                <i data-lucide="message-circle-plus"></i>
                <span class="dock-label">Chats</span>
            </div>
            <div class="dock-item" onclick="window.location.href='Marketplace.html'">
                <i data-lucide="store"></i>
                <span class="dock-label">Marketplace</span>
            </div>
            <div class="dock-item" onclick="window.location.href='my-apps.html'">
                <i data-lucide="grid-3x3"></i>
                <span class="dock-label">My apps</span>
            </div>
            <div class="dock-item" onclick="window.location.href='Leads-marketing.html'">
                <i data-lucide="focus"></i>
                <span class="dock-label">Leads &amp; Marketing</span>
            </div>
            <div class="dock-item active" onclick="window.location.href='Database.html'">
                <i data-lucide="hard-drive"></i>
                <span class="dock-label">Data</span>
            </div>
            <div class="dock-item" onclick="window.location.href='social-assets.html'">
                <i data-lucide="container"></i>
                <span class="dock-label">Social assets</span>
            </div>
            <div class="dock-item" onclick="window.location.href='organise.html'">
                <i data-lucide="folder"></i>
                <span class="dock-label">Organise</span>
            </div>
            <div class="dock-item" onclick="window.location.href='video.html'">
                <i data-lucide="landmark"></i>
                <span class="dock-label">Financials</span>
            </div>
            <div class="dock-item" onclick="window.location.href='#'">
                <i data-lucide="user"></i>
                <span class="dock-label">Account</span>
            </div>
        </div>
    </div>

    <!-- Main Content -->
    <main class="dashboard-main database-main">
        <div class="database-container">
            <!-- Left Sidebar: Database List -->
            <aside class="database-sidebar-container" id="database-sidebar">
                <!-- Populated by database-list-sidebar.js -->
            </aside>

            <!-- Center: Main Content Area -->
            <div class="database-content">
                <!-- Highlight Tile -->
                <section class="database-highlight">
                    <div class="database-highlight-left">
                        <h2>Database Builder</h2>
                        <p>Spin up collaborative tables, design forms, and automate workflows across your teams in minutes.</p>
                    </div>
                    <div class="database-highlight-actions">
                        <button class="btn-primary" onclick="databaseBuilder.openWizard()">Create Database</button>
                        <button class="btn-secondary" onclick="databaseManager.showImport()">Import Data</button>
                    </div>
                </section>

                <section class="database-quick-tiles">
                    <div class="database-tile">
                        <div class="database-tile-icon">
                            <i data-lucide="sparkles"></i>
                        </div>
                        <div class="database-tile-body">
                            <h3>AI Templates</h3>
                            <p>Jump-start with curated table layouts for CRM, finance, and operations.</p>
                        </div>
                        <button class="btn-secondary btn-pill" onclick="databaseBuilder.openWizard()">Browse Templates</button>
                    </div>

                    <div class="database-tile">
                        <div class="database-tile-icon alt">
                            <i data-lucide="layers"></i>
                        </div>
                        <div class="database-tile-body">
                            <h3>Sync Sources</h3>
                            <p>Connect spreadsheets, APIs, or Supabase tables for live data sync.</p>
                        </div>
                        <button class="btn-secondary btn-pill" onclick="databaseManager.showImport()">Set up Sync</button>
                    </div>

                    <div class="database-tile">
                        <div class="database-tile-icon highlight">
                            <i data-lucide="users"></i>
                        </div>
                        <div class="database-tile-body">
                            <h3>Collaborate</h3>
                            <p>Invite teams, manage permissions, and automate reviews with guardrails.</p>
                        </div>
                        <button class="btn-secondary btn-pill" onclick="databaseManager.showSharing()">Share Access</button>
                    </div>
                </section>

                <!-- View Toggle -->
                <div class="view-toggle" id="view-toggle">
                    <button class="toggle-btn active" data-view="table" onclick="databaseManager.setView('table')">
                        ğŸ“Š Table View
                    </button>
                    <button class="toggle-btn" data-view="form" onclick="databaseManager.setView('form')">
                        ğŸ“ Form View
                    </button>
                    <div class="view-actions">
                        <button class="btn-secondary btn-small" onclick="databaseManager.showFilters()" id="filter-btn">
                            ğŸ” Filter
                        </button>
                        <button class="btn-secondary btn-small" onclick="databaseManager.showImport()" id="import-btn">
                            ğŸ“¥ Import
                        </button>
                        <button class="btn-secondary btn-small" onclick="databaseManager.showReports()" id="report-btn">
                            ğŸ“Š Reports
                        </button>
                        <button class="btn-secondary btn-small" onclick="databaseManager.showSharing()" id="share-btn">
                            ğŸ”— Share
                        </button>
                    </div>
                </div>

                <!-- Empty State -->
                <div class="database-empty-state" id="database-empty-state">
                    <div class="empty-state-content">
                        <h2>Welcome to Database Builder</h2>
                        <p>Create simple databases for your data. Perfect for contacts, inventory, recipes, and more.</p>
                        <button class="btn-primary btn-large" onclick="databaseBuilder.openWizard()">
                            â• Create Your First Database
                        </button>
                    </div>
                </div>

                <!-- Table View -->
                <div class="table-view-container" id="table-view" style="display: none;">
                    <!-- Populated by table-view.js -->
                </div>

                <!-- Form View -->
                <div class="form-view-container" id="form-view" style="display: none;">
                    <!-- Populated by form-view.js -->
                </div>
            </div>
        </div>
        
        <!-- Content Tile -->
        <div class="front-tile">
            <div class="front-tile-container">
                <!-- Content for the front tile -->
            </div>
        </div>
    </main>

    <!-- Database Builder Wizard Modal -->
    <div class="wizard-modal" id="database-wizard" style="display: none;">
        <div class="wizard-modal-content">
            <div class="wizard-close" onclick="databaseBuilder.closeWizard()">Ã—</div>
            <div id="wizard-container">
                <!-- Populated by database-builder.js -->
            </div>
        </div>
    </div>

    <!-- Scripts -->
    <script src="supabase-config.js"></script>
    <script src="templates.js"></script>
    <script src="client-database-service.js"></script>
    <script src="backup-service.js"></script>
    <script src="database-list-sidebar.js"></script>
    <script src="database-builder.js"></script>
    <script src="table-view.js"></script>
    <script src="form-view.js"></script>
    <script src="import-service.js"></script>
    <script src="view-builder.js"></script>
    <script src="report-generator.js"></script>
    <script src="sharing-service.js"></script>
    <script src="storage-service.js"></script>
    <script src="realtime-service.js"></script>
    
    <script>
        // Database Manager - Coordinates all components
        class DatabaseManager {
            constructor() {
                this.currentView = 'table';
                this.currentTableName = null;
                this.currentTableSchema = null;
            }

            async init() {
                // Initialize sidebar
                if (window.databaseListSidebar) {
                    await window.databaseListSidebar.init('database-sidebar');
                }

                // Initialize wizard
                if (window.databaseBuilder) {
                    window.databaseBuilder.init('wizard-container');
                }

                // Show empty state initially
                this.showEmptyState();
            }

            setView(view) {
                this.currentView = view;
                
                // Update toggle buttons
                document.querySelectorAll('.toggle-btn').forEach(btn => {
                    btn.classList.remove('active');
                    if (btn.dataset.view === view) {
                        btn.classList.add('active');
                    }
                });

                // Show/hide views
                const tableView = document.getElementById('table-view');
                const formView = document.getElementById('form-view');
                const emptyState = document.getElementById('database-empty-state');

                if (this.currentTableName && this.currentTableSchema) {
                    tableView.style.display = view === 'table' ? 'block' : 'none';
                    formView.style.display = view === 'form' ? 'block' : 'none';
                    emptyState.style.display = 'none';

                    // Initialize the selected view
                    if (view === 'table' && window.tableView) {
                        window.tableView.init(this.currentTableName, this.currentTableSchema, 'table-view');
                    } else if (view === 'form' && window.formView) {
                        window.formView.init(this.currentTableName, this.currentTableSchema, 'form-view');
                    }
                } else {
                    this.showEmptyState();
                }
            }

            async loadDatabase(database) {
                if (!database) {
                    this.showEmptyState();
                    return;
                }

                // Show empty state until a table is selected
                this.showEmptyState();
            }

            async loadTable(tableName, tableSchema) {
                if (!tableName || !tableSchema) {
                    this.showEmptyState();
                    return;
                }

                this.currentTableName = tableName;
                this.currentTableSchema = tableSchema;

                // Hide empty state
                document.getElementById('database-empty-state').style.display = 'none';

                // Show view toggle
                document.getElementById('view-toggle').style.display = 'flex';

                // Load the current view
                this.setView(this.currentView);
            }

            showFilters() {
                if (this.currentTableSchema && window.viewBuilder) {
                    window.viewBuilder.showFilterBuilder(this.currentTableSchema, (filters) => {
                        if (window.tableView) {
                            window.tableView.setFilters(filters);
                        }
                    });
                }
            }

            showImport() {
                if (!this.currentTableName || !this.currentTableSchema) {
                    alert('Please select a table first');
                    return;
                }

                const input = document.createElement('input');
                input.type = 'file';
                input.accept = '.csv,.xlsx,.xls';
                input.onchange = (e) => {
                    const file = e.target.files[0];
                    if (file && window.importService) {
                        window.importService.handleFileSelect(
                            file,
                            this.currentTableSchema,
                            null,
                            () => {
                                // Reload table data after import
                                if (window.tableView) {
                                    window.tableView.loadData().then(() => {
                                        window.tableView.render();
                                    });
                                }
                            }
                        );
                    }
                };
                input.click();
            }

            showReports() {
                if (!this.currentTableName || !this.currentTableSchema) {
                    alert('Please select a table first');
                    return;
                }

                if (window.tableView && window.reportGenerator) {
                    const data = window.tableView.data || [];
                    window.reportGenerator.showReportModal(data, this.currentTableSchema);
                }
            }

            showSharing() {
                if (!this.currentDatabase) {
                    alert('Please select a database first');
                    return;
                }

                if (window.sharingService) {
                    window.sharingService.showSharingModal(
                        this.currentDatabase.id,
                        this.currentDatabase.name
                    );
                }
            }

            async loadDatabase(database) {
                this.currentDatabase = database;
                if (!database) {
                    this.showEmptyState();
                    return;
                }
                // Show empty state until a table is selected
                this.showEmptyState();
            }

            showEmptyState() {
                document.getElementById('database-empty-state').style.display = 'flex';
                document.getElementById('table-view').style.display = 'none';
                document.getElementById('form-view').style.display = 'none';
                document.getElementById('view-toggle').style.display = 'none';
                this.currentTableName = null;
                this.currentTableSchema = null;
            }

            clearContent() {
                this.showEmptyState();
            }
        }

        // Initialize on page load
        document.addEventListener('DOMContentLoaded', async () => {
            // Initialize Lucide icons
            if (window.lucide) lucide.createIcons();

            // Initialize dock labels
            const dockItems = Array.from(document.querySelectorAll('.dock-item'));
            dockItems.forEach(item => {
                const label = item.querySelector('.dock-label');
                if (label) {
                    item.addEventListener('mouseenter', () => {
                        const rect = item.getBoundingClientRect();
                        label.style.top = `${rect.top + rect.height / 2 - 100}px`;
                    });
                }
            });

            // Initialize database manager
            const databaseManager = new DatabaseManager();
            window.databaseManager = databaseManager;
            await databaseManager.init();

            // Initialize share access if accessed via share link
            if (window.sharingService) {
                await window.sharingService.initShareAccess();
            }
        });
    </script>
</body>
</html>
